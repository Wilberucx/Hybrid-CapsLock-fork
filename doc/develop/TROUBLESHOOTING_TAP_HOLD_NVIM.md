# Troubleshooting: CapsLock Tap vs Hold for NVIM Layer (HybridCapsLock)

This document captures the investigation, fix, and configuration for reliable CapsLock tap detection that toggles the NVIM layer without false activations on long holds or modifier combos.

1) Current code implemented

- Hotkey implementation (src/layer/nvim_layer.ahk — KeyWait-based)

```autohotkey
~*CapsLock:: {
    global nvimLayerEnabled, isNvimLayerActive, VisualMode
    global capsTapThresholdMs, capsLockUsedAsModifier, debug_mode
    if (!nvimLayerEnabled)
        return
    capsLockUsedAsModifier := false ; reset at down
    downTick := A_TickCount
    KeyWait("CapsLock") ; wait for release
    dur := A_TickCount - downTick
    if (debug_mode)
        OutputDebug "[NVIM] KeyWait dur=" dur ", usedAsMod=" capsLockUsedAsModifier ", thr=" capsTapThresholdMs "\n"
    if (capsLockUsedAsModifier)
        return ; used as modifier, do not toggle
    if (dur >= capsTapThresholdMs)
        return ; long hold, ignore
    ; Toggle
    isNvimLayerActive := !isNvimLayerActive
    if (isNvimLayerActive) {
        ShowNvimLayerStatus(true)
        SetTempStatus("NVIM LAYER ON", 1500)
    } else {
        VisualMode := false
        ShowNvimLayerStatus(false)
        SetTempStatus("NVIM LAYER OFF", 1500)
    }
    try SaveLayerState()
}
```

- Global variables related to CapsLock (src/core/globals.ahk)

```autohotkey
; ---- Layer runtime states ----
global isNvimLayerActive := false
global _tempEditMode := false
global VisualMode := false

; Other runtime flags
global capsLockWasHeld := false
global capsLockUsedAsModifier := false
; Tap detection for CapsLock
global capsTapThresholdMs := 250  ; configurable via configuration.ini [Behavior].nvim_tap_threshold_ms
```

- Helper functions used by the hotkey
  - ShowNvimLayerStatus / SetTempStatus / SaveLayerState are defined in UI/persistence modules and display/persist the NVIM state. No ToggleLayer() is used; the code directly toggles `isNvimLayerActive`.

2) Project structure

- Entry point and initialization (init.ahk):
  - Includes core (globals, config, persistence, confirmations, mappings), UI tooltips, and all layers.
  - On startup, calls `LoadLayerFlags()` and `LoadLayerState()` and sets `SetCapsLockState("AlwaysOff")`.

- Layers that interact with CapsLock (src/layer/):
  - leader_router.ahk (CapsLock & Space)
  - modifier_mode.ahk (CapsLock & key — many combos)
  - nvim_layer.ahk (tap toggles NVIM layer; context hotkeys under #HotIf)
  - excel_layer.ahk (layer context excludes physical CapsLock down)

- Logging system:
  - Uses AutoHotkey `OutputDebug` for diagnostic logs. Controlled by `General.debug_mode` in configuration.ini (loaded in `LoadLayerFlags`).

3) Configuration

- Adjustable threshold:
  - configuration.ini → [Behavior] `nvim_tap_threshold_ms=250` (ms). Read at startup by `LoadLayerFlags()` and assigned to `capsTapThresholdMs`.
  - Not hardcoded: default is 250, but it is configurable.

4) Additional context

- What the toggle does:
  - Toggling NVIM means flipping `isNvimLayerActive`. When ON, context hotkeys under `#HotIf (isNvimLayerActive && !GetKeyState("CapsLock", "P") ...)` become active.

- Other CapsLock features:
  - Modifier Mode (doc/MODIFIER_MODE.md): CapsLock acts as a modifier for many combos (CapsLock + h/j/k/l, etc.). These mark `capsLockUsedAsModifier=true` to prevent accidental NVIM toggles.
  - NVIM Layer doc (doc/NVIM_LAYER.md) describes commands, yank/delete menus, visual/insert modes.

5) Debugging details

- How the debug output is generated:
  - In `nvim_layer.ahk`, after KeyWait, when `debug_mode=true` it calls:
    `OutputDebug "[NVIM] KeyWait dur=" dur ", usedAsMod=" capsLockUsedAsModifier ", thr=" capsTapThresholdMs`"`
  - Logs can be viewed with tools like DebugView; a consolidated file (debug.log) can be generated by the host environment.

- How to enable/disable debug logs:
  - configuration.ini → [General] `debug_mode=true/false`.
  - Loaded in `LoadLayerFlags()` and used to gate OutputDebug.

Notes
- Legacy SC03A scancode handlers were removed to avoid interference; KeyWait-based approach mirrors the validated tester script and avoids repeat "down" issues.
- If a tap is mis-detected, adjust `nvim_tap_threshold_ms` (e.g., 300–350 ms) and retest.
- Ensure combo hotkeys call `MarkCapsLockAsModifier()` (already handled in static/dynamic mappings for Modifier) so taps during combos do not toggle NVIM.
