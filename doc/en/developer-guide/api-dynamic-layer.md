# Dynamic Layer API Reference

**Core Plugin** | `system/plugins/dynamic_layer.ahk`

Dynamic Layer provides a system to automatically activate layers based on the active application. It allows you to assign specific layers to processes and activate them with a simple CapsLock tap.

## üéØ Design Philosophy

Dynamic Layer is a **core plugin** that:
- Manages bindings between processes and layers
- Persists configuration in JSON
- Provides GUIs for binding management
- Integrates with the layer system

## üìö Main Functions

### `ActivateDynamicLayer()`

Manually activates the layer assigned to the current process.

**Parameters:** None

**Returns:** `Boolean` - `true` if a layer was activated, `false` otherwise

**Behavior:**
1. Gets the active process using `GetActiveProcessName()`
2. Searches in `data/layer_bindings.json` if there's an assigned layer
3. If it exists, activates that layer with `SwitchToLayer()` (system automatically preserves current layer as previous since v2025-12-06)
4. Shows tooltip with result

**Example:**

```autohotkey
; Activate layer for current process
ActivateDynamicLayer()

; Use in keymap (already configured in keymap.ahk)
#HotIf (DYNAMIC_LAYER_ENABLED)
F23:: ActivateDynamicLayer()  ; Tap CapsLock
#HotIf

; Use in Leader menu
RegisterKeymap("leader", "d", "Dynamic Layer", ActivateDynamicLayer, false, 1)
```

**Tooltip Messages:**
- `"Dynamic Layer system is disabled"` - If `DYNAMIC_LAYER_ENABLED` is false
- `"Unable to detect active process"` - If process cannot be obtained
- `"No layer bound to: [process]"` - If no layer is assigned
- Activates the layer if everything is correct

---

### `ToggleDynamicLayer()`

Enables or disables the Dynamic Layer system globally.

**Parameters:** None

**Returns:** Void

**Behavior:**
- Changes the value of `DYNAMIC_LAYER_ENABLED`
- Shows tooltip with current state

**Example:**

```autohotkey
; Toggle the system
ToggleDynamicLayer()

; Use in keymap
RegisterKeymap("leader", "h", "t", "Toggle Dynamic Layer", ToggleDynamicLayer, false, 8)
```

**States:**
- `"Dynamic Layer: ENABLED"` - System activated
- `"Dynamic Layer: DISABLED"` - System deactivated

---

### `ShowBindProcessGui()`

Shows GUI to assign a layer to the currently active process.

**Parameters:** None

**Returns:** Void

**Behavior:**
1. Detects the active process
2. Loads available layers from `data/layers.json`
3. Shows GUI with layer list
4. Allows selecting and assigning layer to process
5. Saves binding in `data/layer_bindings.json`

**Example:**

```autohotkey
; Open GUI to register process
ShowBindProcessGui()

; Use in keymap
RegisterKeymap("leader", "h", "r", "Register Process", ShowBindProcessGui, false, 7)
```

**User Flow:**
1. Open the application you want to configure (e.g., Excel)
2. Press `Leader ‚Üí h ‚Üí r`
3. Select the layer from the list (e.g., "excel")
4. Click "Bind"
5. Now tapping CapsLock in Excel will activate the Excel layer

---

### `ShowBindingsListGui()`

Shows GUI with list of all configured bindings.

**Parameters:** None

**Returns:** Void

**Behavior:**
1. Loads bindings from `data/layer_bindings.json`
2. Loads layer names from `data/layers.json`
3. Shows list with format: `process ‚Üí layer_name`

**Example:**

```autohotkey
; View configured bindings
ShowBindingsListGui()

; Use in keymap
RegisterKeymap("leader", "h", "b", "List Bindings", ShowBindingsListGui, false, 9)
```

**Example Output:**
```
EXCEL.EXE ‚Üí Excel Layer
Code.exe ‚Üí VS Code Layer
chrome.exe ‚Üí Browser Layer
```

---

## üóÇÔ∏è Persistence System

### JSON Files

#### `data/layer_bindings.json`

Stores bindings between processes and layers.

**Format:**
```json
{
  "EXCEL.EXE": "excel",
  "Code.exe": "vscode",
  "chrome.exe": "browser"
}
```

#### `data/layers.json`

Auto-generated by `RegisterLayer()`, contains metadata of all layers.

**Format:**
```json
{
  "layers": [
    {"id": "excel", "name": "Excel Layer"},
    {"id": "vscode", "name": "VS Code Layer"}
  ],
  "lastUpdate": "2025-11-28T01:00:00"
}
```

---

## üé® Usage Patterns

### Pattern 1: Configure Layer for Application

```autohotkey
; 1. Create the layer
RegisterLayer("excel", "EXCEL", "#10B981", "#FFFFFF")
RegisterKeymap("excel", "j", "Down Cell", () => Send("{Down}"), false, 1)
RegisterKeymap("excel", "k", "Up Cell", () => Send("{Up}"), false, 2)

; 2. Open Excel
; 3. Press Leader ‚Üí h ‚Üí r
; 4. Select "excel" from the list
; 5. Click "Bind"

; Now tapping CapsLock in Excel activates the Excel layer
```

### Pattern 2: Check Current Bindings

```autohotkey
; See which processes have assigned layers
ShowBindingsListGui()

; Or programmatically
bindings := LoadLayerBindings()
for process, layerId in bindings {
    MsgBox(process . " ‚Üí " . layerId)
}
```

### Pattern 3: Manual Activation

```autohotkey
; Activate layer of current process without tapping CapsLock
ActivateDynamicLayer()

; Useful for testing or debugging
```

---

## üìã Best Practices

### 1. Create the Layer Before Assigning It

```autohotkey
; ‚úÖ Good - layer exists
RegisterLayer("excel", "EXCEL", "#10B981", "#FFFFFF")
; ... register keymaps ...
; Now assign with GUI

; ‚ùå Bad - assign non-existent layer
; ShowBindProcessGui() ‚Üí select non-existent layer
```

### 2. Use Exact Process Names

Process names are case-sensitive:
- ‚úÖ `"EXCEL.EXE"` (correct)
- ‚ùå `"excel.exe"` (may not work)

Use `GetActiveProcessName()` to verify the exact name.

### 3. Disable the System if Not Using It

```autohotkey
; If not using Dynamic Layer, disable it
global DYNAMIC_LAYER_ENABLED := false
```

---

## üîç Debugging

```autohotkey
; Enable logging
Log.SetLevel("DEBUG")

; Test process detection
process := GetActiveProcessName()
Log.d("Active process: " . process, "DYNAMIC_LAYER")

; Test binding
layerId := GetLayerForProcess(process)
Log.d("Assigned layer: " . layerId, "DYNAMIC_LAYER")

; Test activation
result := ActivateDynamicLayer()
Log.d("Activation successful: " . result, "DYNAMIC_LAYER")
```

---

## üÜö Comparison with Other Systems

| Aspect | Dynamic Layer | Manual Layers |
|---------|---------------|---------------|
| **Activation** | Automatic (tap CapsLock) | Manual (Leader ‚Üí key) |
| **Configuration** | Visual GUI | Code in keymap.ahk |
| **Persistence** | Automatic JSON | Static code |
| **Flexibility** | By process | By need |

---

## üìñ See Also

- [Context Utils API](api-context-utils.md) - `GetActiveProcessName()` used by Dynamic Layer
- [Layer System](../user-guide/layers.md) - How to create layers
- [Key Concepts](../user-guide/concepts.md) - Explanation of Dynamic Layer system
